<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>表单转 PDF - 创建表单</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <!-- 头部 -->
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">表单转 PDF</h1>
      <p class="text-gray-600 mt-2">创建表单，收集数据，自动生成 PDF 下载</p>
    </header>

    <!-- 表单设置 -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">表单信息</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">表单标题 *</label>
          <input type="text" id="formTitle" placeholder="例如：客户信息登记表"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">表单描述</label>
          <textarea id="formDesc" rows="2" placeholder="简单描述这个表单的用途..."
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
        </div>
      </div>
    </div>

    <!-- 添加字段 -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">添加字段</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">字段标签</label>
          <input type="text" id="fieldLabel" placeholder="例如：姓名"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">字段名称</label>
          <input type="text" id="fieldName" placeholder="例如：name"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">字段类型</label>
          <select id="fieldType"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="text">文本</option>
            <option value="email">邮箱</option>
            <option value="tel">电话</option>
            <option value="number">数字</option>
            <option value="date">日期</option>
            <option value="textarea">多行文本</option>
          </select>
        </div>
        <div class="flex items-end">
          <button onclick="addField()"
            class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition">
            添加字段
          </button>
        </div>
      </div>

      <!-- 字段列表 -->
      <div id="fieldsList" class="space-y-2"></div>
    </div>

    <!-- 创建按钮 -->
    <div class="flex gap-4">
      <button onclick="createForm()"
        class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
        创建表单
      </button>
      <button onclick="loadForms()"
        class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
        查看已有表单
      </button>
    </div>

    <!-- 已有表单列表 -->
    <div id="formsList" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">已有表单</h3>
      <div id="formsContainer" class="space-y-3"></div>
    </div>

    <!-- 创建成功 -->
    <div id="successMessage" class="mt-6 hidden">
      <div class="bg-green-50 border border-green-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-green-800 mb-2">表单创建成功！</h3>
        <p class="text-green-700 mb-4">使用以下链接分享你的表单：</p>
        <div class="flex gap-2">
          <input type="text" id="formUrl" readonly
            class="flex-1 px-3 py-2 bg-white border border-green-300 rounded-md text-green-800">
          <button onclick="copyUrl()"
            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition">
            复制
          </button>
          <a id="openFormBtn" href="#" target="_blank"
            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
            打开
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    let fields = [];

    // 自动生成字段名
    document.getElementById('fieldLabel').addEventListener('input', (e) => {
      if (!document.getElementById('fieldName').value) {
        document.getElementById('fieldName').value =
          e.target.value.toLowerCase().replace(/\s+/g, '_').replace(/[^\w]/g, '');
      }
    });

    function addField() {
      const label = document.getElementById('fieldLabel').value.trim();
      const name = document.getElementById('fieldName').value.trim();
      const type = document.getElementById('fieldType').value;

      if (!label || !name) {
        alert('请填写字段标签和名称');
        return;
      }

      // 检查重复
      if (fields.find(f => f.name === name)) {
        alert('字段名已存在');
        return;
      }

      fields.push({ label, name, type });
      renderFields();

      // 清空输入
      document.getElementById('fieldLabel').value = '';
      document.getElementById('fieldName').value = '';
      document.getElementById('fieldLabel').focus();
    }

    function removeField(index) {
      fields.splice(index, 1);
      renderFields();
    }

    function renderFields() {
      const list = document.getElementById('fieldsList');
      list.innerHTML = fields.map((f, i) => `
        <div class="flex items-center justify-between bg-gray-50 px-4 py-2 rounded-md">
          <span>
            <span class="font-medium">${f.label}</span>
            <span class="text-gray-500 text-sm ml-2">(${f.name})</span>
            <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded ml-2">${f.type}</span>
          </span>
          <button onclick="removeField(${i})" class="text-red-600 hover:text-red-800">
            删除
          </button>
        </div>
      `).join('');
    }

    async function createForm() {
      const title = document.getElementById('formTitle').value.trim();
      const desc = document.getElementById('formDesc').value.trim();

      if (!title) {
        alert('请输入表单标题');
        return;
      }

      if (fields.length === 0) {
        alert('请至少添加一个字段');
        return;
      }

      try {
        const res = await fetch('/api/forms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title,
            description: desc,
            fields
          })
        });

        const data = await res.json();

        if (data.success) {
          const url = `${window.location.origin}/form/${data.form.slug}`;
          document.getElementById('formUrl').value = url;
          document.getElementById('openFormBtn').href = url;
          document.getElementById('successMessage').classList.remove('hidden');

          // 重置表单
          document.getElementById('formTitle').value = '';
          document.getElementById('formDesc').value = '';
          fields = [];
          renderFields();
        }
      } catch (error) {
        alert('创建失败：' + error.message);
      }
    }

    async function loadForms() {
      try {
        const res = await fetch('/api/forms');
        const data = await res.json();

        const container = document.getElementById('formsContainer');
        const listDiv = document.getElementById('formsList');

        if (data.forms.length === 0) {
          container.innerHTML = '<p class="text-gray-500">暂无表单</p>';
        } else {
          container.innerHTML = data.forms.map(f => `
            <div class="bg-white border border-gray-200 rounded-lg p-4 flex items-center justify-between">
              <div>
                <h4 class="font-semibold">${f.title}</h4>
                <p class="text-sm text-gray-500">${f.description || '无描述'}</p>
                <p class="text-xs text-gray-400 mt-1">创建于 ${new Date(f.created_at).toLocaleString('zh-CN')}</p>
              </div>
              <div class="flex gap-2">
                <a href="/form/${f.slug}" target="_blank"
                  class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                  填写
                </a>
                <a href="${window.location.origin}/form/${f.slug}" target="_blank"
                  class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50">
                  链接
                </a>
                <button onclick="deleteForm(${f.id})" class="px-3 py-1 text-sm text-red-600 hover:bg-red-50 rounded">
                  删除
                </button>
              </div>
            </div>
          `).join('');
        }

        listDiv.classList.toggle('hidden');
      } catch (error) {
        alert('加载失败：' + error.message);
      }
    }

    async function deleteForm(id) {
      if (!confirm('确定删除这个表单吗？')) return;

      try {
        await fetch(`/api/forms/${id}`, { method: 'DELETE' });
        loadForms();
      } catch (error) {
        alert('删除失败：' + error.message);
      }
    }

    function copyUrl() {
      const input = document.getElementById('formUrl');
      input.select();
      navigator.clipboard.writeText(input.value);
      alert('已复制到剪贴板');
    }
  </script>
</body>
</html>
